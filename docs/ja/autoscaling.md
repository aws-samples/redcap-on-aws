JP | [EN](../en/autoscaling.md)

# App Runner のオートスケーリングの設定

このプロジェクトでは、REDCap をホスト環境として AWS App Runner を使用します。このページでは App Runner のスケーリングに関する設定について解説します。

## App Runner のオートスケーリングに関するパラメーター

| パラメーター    | stage ファイルでの名称 | 説明                                                                                                                                                                                                                                                                                                                                               | 決定の仕方                                                                                                                                                                                                                                                                                                                                                                        |
| --------------- | ---------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Max Concurrency | `appRunnerConcurrency` | 1つのインスタンスが処理する並行するリクエストの上限数。 同時リクエスト数がこの設定値を上回った場合、App Runnerはサービスをスケールアウトします。                                                                                                                                                                                                   | このパラメーターを適切に設定するには負荷試験を行う必要があります。 詳しくは [負荷試験](#負荷試験) を参考にしてください。                                                                                                                                                                                                                                                          |
| Max Size        | `appRunnerMaxSize`     | スケールアウトできるインスタンス数の上限を設定します。これは、トラフィックを同時に処理するインスタンスの最大数です。                                                                                                                                                                                                                               | 高負荷のトラフィックに対応できるようにしたい場合は、高い値から始めて、ピーク負荷を検出した後に調整することをお勧めします。これにより、DoS 攻撃のような予期しないトラフィックが来てもスケールアップしないように、システムのコスト管理を行うことができます。 どのくらいのインスタンス数でどれくらいのリクエストが処理できるのかについては、[負荷試験](#負荷試験) もご参照ください。 |
| Min Size        | `appRunnerMinSize`     | App Runner がサービス用にプロビジョニングできるインスタンスの最小数。 サービスには常に少なくともこの数のプロビジョニングされたインスタンスがあります。 これらのインスタンスの一部はトラフィックをアクティブに処理します。 残りは費用対効果の高いコンピューティングキャパシティリザーブの一部であり、トラフィックに応じてすぐに利用可能になります。 | MinSizeは、ピーク時にユーザーにエラーを発生させて、スケールアッププロセスが完了するまで待たせるかどうかによって異なります。 実稼働システムで、負荷が不明な場合、これを 1 に設定するのは危険です。 2-3 から始めて、負荷とピークがわかったら 1 に減らすのが良いでしょう。 MinSize はインスタンスをウォーム状態にします。お支払いいただくのは割り当てられたメモリの分のみです。      |

詳しくは以下のリンクを参照ください。
https://docs.aws.amazon.com/apprunner/latest/dg/manage-autoscaling.html

### App Runner の料金体系

App Runner は 2 種類の価格設定に基づいています。

トラフィックを処理しないプロビジョニングされたインスタンスの場合、コストはメモリ使用量に対してのみ発生します。
トラフィックを処理するアクティブなインスタンスの場合、CPU 使用量とメモリ使用量の両方にコストがかかります。

単価は地域によって異なります。 たとえば、ap-northeast-1 (東京) では、メモリ使用量が 0.009 USD/GB、CPU 使用量が 0.081 USD/vCPU です。
メモリの単価は、インスタンスがトラフィックを処理するかどうかに関係なく一定です。

詳細については、以下のリンクを参照してください。
https://aws.amazon.com/apprunner/pricing/

### 負荷試験

適切なパラメータ設定のため、私たちは負荷試験を行いました。

#### 環境

負荷試験は [locast](https://locust.io/) を用いて行なっています。
これは Python 製のメジャーな負荷試験ツールです。

負荷試験は REDCap Ver.13.7.2 で行なっています。

#### 結果

2vCPUs と 4GB RAM のインスタンスを用いた結果が以下です。

| ユーザー数 | RPS | 同時リクエスト数 | CPU 使用率 | メモリ使用率 | ステータス | エンドポイント | レイテンシー(平均) | コメント                             |
| ---------- | --- | ---------------- | ---------- | ------------ | ---------- | -------------- | ------------------ | ------------------------------------ |
| 30         | 8   | 4                | 1000       | 220          | ok         | /              |                    | 70 concurrency will crash the server |
| 60         | 9   | 29               | 1888       | 640          | FAIL       | /              | 750                | 29 concurrency you have cpu 200%     |
| 125        | 13  | 74               | 2000       | 1300         | FAIL       | /              | 5000               |                                      |
| 90         | 15  | 47               | 2000       | 988          | FAIL       | /              | 2900               |                                      |

1 つのインスタンスで 30 人のユーザーをサポートするには、2 つの vCPU と 4GB の RAM で問題ありません。
40 人のユーザーが約 10rps でアクセスすると、CPU 使用率は 140 ％に達します。これは、同時実行数としては 2~4 になります。
60 人のユーザーがいる場合、CPU 使用率は 200% になり、同時実行数は 30 に急増します。 この時点でスケールアウトしても遅いです。

上記の結果から、vCPU　の数が`2`に設定され、メモリが`4GB` に設定されている場合は、`最大同時実行数`を`25`程度に設定することをお勧めします。
